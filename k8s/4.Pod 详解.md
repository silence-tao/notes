# 1.Pod 的介绍

## 1.1 Pod 的结构

![image-20210610001540775](../img/image-20210610001540775.png)

每个 Pod 中都包含一个或者多个容器，这些容器可以分为两类：

1. 用户程序所在的容器，数量可多可少。

2. Pause 容器，这是每个 Pod 都会有的一个根容器，它的作用有两个：

   - 可以以它为依据，评估整个 Pod 的健康状况。

   - 可以在根容器上设置 IP 地址，其它容器都共享此 IP（Pod 的 IP），以实现 Pod 内部的网络通信。

     > 这里是 Pod 内部的通讯，Pod 之间的通讯采用虚拟二层网络技术来实现，我们当前环境使用的是  weave-net。

## 1.2 Pod 定义

### 1.2.1 Pod 的资源清单

下面是 Pod 的资源清单：

```yaml
apiVersion: v1     # 必选，版本号，例如 v1
kind: Pod       　 # 必选，资源类型，例如 Pod
metadata:       　 # 必选，元数据
  name: string     # 必选，Pod 名称
  namespace: string  # Pod 所属的命名空间,默认为 "default"
  labels:       　　  # 自定义标签列表
    - name: string      　          
spec:  # 必选，Pod 中容器的详细定义
  containers:  # 必选，Pod 中容器列表
  - name: string   # 必选，容器名称
    image: string  # 必选，容器的镜像名称
    imagePullPolicy: [ Always|Never|IfNotPresent ]  # 获取镜像的策略 
    command: [string]   # 容器的启动命令列表，如不指定，使用打包时使用的启动命令
    args: [string]      # 容器的启动命令参数列表
    workingDir: string  # 容器的工作目录
    volumeMounts:       # 挂载到容器内部的存储卷配置
    - name: string      # 引用 pod 定义的共享存储卷的名称，需用 volumes[] 部分定义的的卷名
      mountPath: string # 存储卷在容器内 mount 的绝对路径，应少于 512 字符
      readOnly: boolean # 是否为只读模式
    ports: # 需要暴露的端口库号列表
    - name: string        # 端口的名称
      containerPort: int  # 容器需要监听的端口号
      hostPort: int       # 容器所在主机需要监听的端口号，默认与 Container 相同
      protocol: string    # 端口协议，支持 TCP 和 UDP，默认 TCP
    env:   # 容器运行前需设置的环境变量列表
    - name: string  # 环境变量名称
      value: string # 环境变量的值
    resources: # 资源限制和请求的设置
      limits:  # 资源限制的设置
        cpu: string     # Cpu 的限制，单位为 core 数，将用于 docker run --cpu-shares 参数
        memory: string  #内存限制，单位可以为 Mib/Gib，将用于 docker run --memory 参数
      requests: # 资源请求的设置
        cpu: string    # Cpu 请求，容器启动的初始可用数量
        memory: string # 内存请求,容器启动的初始可用数量
    lifecycle: # 生命周期钩子
        postStart: # 容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启
        preStop: # 容器终止前执行此钩子,无论结果如何,容器都会终止
    livenessProbe:  # 对 Pod 内各容器健康检查的设置，当探测无响应几次后将自动重启该容器
      exec:       　 # 对 Pod 容器内检查方式设置为 exec 方式
        command: [string]  # exec 方式需要制定的命令或脚本
      httpGet:       # 对 Pod 内个容器健康检查方法设置为 HttpGet，需要制定 Path、port
        path: string
        port: number
        host: string
        scheme: string
        HttpHeaders:
        - name: string
          value: string
      tcpSocket:     # 对 Pod 内个容器健康检查方式设置为 tcpSocket 方式
         port: number
       initialDelaySeconds: 0      # 容器启动完成后首次探测的时间，单位为秒
       timeoutSeconds: 0    　　    # 对容器健康检查探测等待响应的超时时间，单位秒，默认 1 秒
       periodSeconds: 0     　　    # 对容器监控检查的定期探测时间设置，单位秒，默认 10 秒一次
       successThreshold: 0
       failureThreshold: 0
       securityContext:
         privileged: false
  restartPolicy: [Always | Never | OnFailure]  # Pod 的重启策略
  nodeName: <string> # 设置 NodeName 表示将该 Pod 调度到指定到名称的 node 节点上
  nodeSelector: obeject # 设置 NodeSelector 表示将该 Pod 调度到包含这个 label 的 node 上
  imagePullSecrets: # Pull镜像时使用的 secret 名称，以 key：secretkey 格式指定
  - name: string
  hostNetwork: false   # 是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络
  volumes:   # 在该 pod 上定义共享存储卷列表
  - name: string    # 共享存储卷名称 （volumes 类型有很多种）
    emptyDir: {}       # 类型为 emtyDir 的存储卷，与 Pod 同生命周期的一个临时目录。为空值
    hostPath: string   # 类型为 hostPath 的存储卷，表示挂载 Pod 所在宿主机的目录
      path: string     # Pod 所在宿主机的目录，将被用于同期中 mount 的目录
    secret:       　　　# 类型为 secret 的存储卷，挂载集群与定义的 secret 对象到容器内部
      scretname: string  
      items:     
      - key: string
        path: string
    configMap:         # 类型为 configMap 的存储卷，挂载预定义的 configMap对象到容器内部
      name: string
      items:
      - key: string
        path: string
```

### 1.2.2 查看资源的可配置项

1.语法：查看每种资源的可配置项

查看某种资源可以配置的一级配置

```bash
$ kubectl explain <资源类型>
```

查看属性的子属性

``` bash
$ kubectl explain <资源类型.属性>
```

2.示例：查看资源类型为 pod 的可配置项

```bash
$ kubectl explain pod
```

3.示例：查看资源类型为 Pod 的 metadata 的属性的可配置项

```bash
$ kubectl explain pod.metadata
```

### 1.2.3 kubernetes 资源属性介绍

在 kubernetes 中基本所有资源的一级属性都是一样的，主要包含5个部分：

1. apiVersion `<string>`：版本，由 kubernetes 内部定义，版本号必须用 kubectl api-versions 查询；
2. kind `<string>`：类型，有 kubernetes 内部定义，类型必须用 kubectl api-resources 查询；
3. metadata `<Object>`：元数据，主要是资源标识和说明，常用的有 name、namespace、labels 等；
4. spec `<Object>`：描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述；
5. status `<Object>`：状态信息，里面的内容不需要定义，由 kubernetes 自动生成。

在上面的属性中，spec 是接下来研究的重点，继续看下它的常见子属性：

1. containers  `<[]Object>`：容器列表，用于定义容器的详细信息；
2. nodeName `<string>`：根据 nodeName 的值将 Pod 调度到指定的 Node 节点上；
3. nodeSelector `<map[string]string>`：根据 NodeSelector 中定义的信息选择该 Pod 调度到包含这些 Label 的 Node 上；
4. hostNetwork `<boolean>`：是否使用主机网络模式，默认为 false，如果设置为 true，表示使用宿主机网络；
5. volumes `<[]Object>`：存储卷，用于定义 Pod 上面挂载的存储信息；
6. restartPolicy `<string>`：重启策略，表示 Pod 在遇到故障的时候的处理策略。

